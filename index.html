<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½å¯¹è´¦å·¥å…· - Auto Reconciliation</title>
  <!-- Vue3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Element Plus -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
  <script src="https://unpkg.com/element-plus"></script>
  <script src="https://unpkg.com/@element-plus/icons-vue"></script>
  <!-- SheetJS for Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .app-container {
      min-height: calc(100vh - 40px);
      padding: 20px;
    }

    .main-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(90deg, #4f46e5, #7c3aed);
      color: white;
      padding: 20px 30px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .nav-tabs {
      display: flex;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }

    .nav-tab {
      padding: 16px 24px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #64748b;
    }

    .nav-tab:hover {
      background: #f1f5f9;
      color: #4f46e5;
    }

    .nav-tab.active {
      color: #4f46e5;
      border-bottom-color: #4f46e5;
      background: white;
    }

    .content-area {
      padding: 30px;
      min-height: 600px;
    }

    .upload-zone {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      transition: all 0.3s;
      background: #fafafa;
    }

    .upload-zone:hover {
      border-color: #4f46e5;
      background: #f5f3ff;
    }

    .upload-zone.dragover {
      border-color: #4f46e5;
      background: #ede9fe;
    }

    .file-info-card {
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      border: 1px solid #86efac;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .config-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .match-status-success {
      background: #dcfce7 !important;
    }

    .match-status-error {
      background: #fee2e2 !important;
    }

    .match-status-warning {
      background: #fef3c7 !important;
    }

    .match-status-pending {
      background: #f3f4f6 !important;
    }

    .pdf-preview-container {
      background: #1f2937;
      border-radius: 12px;
      overflow: hidden;
    }

    .pdf-canvas-container {
      display: flex;
      justify-content: center;
      padding: 20px;
      min-height: 500px;
      overflow: auto;
    }

    .stats-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .el-table .cell {
      word-break: break-word;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: #4f46e5;
      border-radius: 2px;
    }

    .action-btn {
      transition: transform 0.2s;
    }

    .action-btn:hover {
      transform: translateY(-2px);
    }

    .fade-enter-active,
    .fade-leave-active {
      transition: opacity 0.3s ease;
    }

    .fade-enter-from,
    .fade-leave-to {
      opacity: 0;
    }

    .progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4f46e5, #7c3aed);
      transition: width 0.3s;
    }

    .contract-card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s;
    }

    .contract-card:hover {
      border-color: #4f46e5;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
    }

    .extracted-data-table {
      margin-top: 16px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #94a3b8;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="app-container">
      <div class="main-card max-w-7xl mx-auto">
        <!-- Header -->
        <div class="header flex justify-between items-center">
          <div>
            <h1>ğŸ”„ åˆåŒè®¢å•ä¿¡æ¯æ™ºèƒ½æå–å·¥å…·</h1>
            <p class="text-sm opacity-80 mt-1">Auto Reconciliation System v1.0</p>
          </div>
          <div class="flex gap-3">
            <el-button type="primary" plain @click="clearAllData" class="action-btn">
              <el-icon>
                <delete />
              </el-icon> æ¸…é™¤æ‰€æœ‰æ•°æ®
            </el-button>
          </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
          <div v-for="(tab, index) in tabs" :key="index" :class="['nav-tab', { active: activeTab === index }]"
            @click="activeTab = index">
            <el-icon>
              <component :is="tab.icon" />
            </el-icon>
            {{ tab.name }}
          </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
          <transition name="fade" mode="out-in">
            <!-- Tab 1: åˆåŒä¸Šä¼  -->
            <div v-if="activeTab === 0" key="contracts">
              <h2 class="section-title">è®¢å•åˆåŒä¸Šä¼ </h2>

              <!-- PDF Upload Zone -->
              <div class="upload-zone" :class="{ dragover: isDraggingPdf }" @dragover.prevent="isDraggingPdf = true"
                @dragleave="isDraggingPdf = false" @drop.prevent="handlePdfDrop">
                <el-icon :size="48" color="#9ca3af"><folder-add /></el-icon>
                <p class="text-lg font-medium text-gray-600 mt-4">æ‹–æ‹½PDFåˆåŒæ–‡ä»¶åˆ°æ­¤å¤„</p>
                <p class="text-sm text-gray-400 mt-2">æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œå•æ–‡ä»¶æœ€å¤§ 20MB</p>
                <el-button type="primary" class="mt-4" @click="triggerPdfUpload">
                  <el-icon><folder-opened /></el-icon> é€‰æ‹©æ–‡ä»¶
                </el-button>
                <input type="file" ref="pdfInput" accept=".pdf" multiple @change="handlePdfUpload"
                  style="display: none">
              </div>

              <!-- Contract List -->
              <div v-if="contractFiles.length > 0" class="mt-6">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="section-title mb-0">å·²ä¸Šä¼ åˆåŒ ({{ contractFiles.length }})</h3>
                  <div class="flex gap-2">
                    <el-button type="success" @click="extractAllContracts" :loading="isExtractingAll">
                      <el-icon><magic-stick /></el-icon> AIæ‰¹é‡æå–
                    </el-button>
                    <el-button type="danger" plain @click="clearAllContracts">
                      <el-icon>
                        <delete />
                      </el-icon> æ¸…é™¤å…¨éƒ¨
                    </el-button>
                  </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div v-for="(contract, idx) in contractFiles" :key="idx" class="contract-card">
                    <div class="flex justify-between items-start">
                      <div class="flex items-center gap-3 flex-1">
                        <div class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center flex-shrink-0">
                          <el-icon :size="20" color="white">
                            <document />
                          </el-icon>
                        </div>
                        <div class="flex-1 min-w-0">
                          <p class="font-medium text-gray-800 truncate">{{ contract.name }}</p>
                          <p class="text-xs text-gray-500">{{ formatFileSize(contract.size) }}</p>
                        </div>
                      </div>
                      <div class="flex gap-1">
                        <el-button type="primary" size="small" circle @click="previewPdf(contract)">
                          æŸ¥çœ‹
                        </el-button>
                        <el-button type="success" size="small" circle @click="extractContractData(contract)"
                          :loading="contract.extracting">
                          æå–
                        </el-button>
                        <el-button type="danger" size="small" circle @click="removeContract(idx)">
                          <el-icon :size="14">
                            <close />
                          </el-icon>
                        </el-button>
                      </div>
                    </div>

                    <!-- Extraction Status -->
                    <div v-if="contract.extracted" class="mt-3 pt-3 border-t">
                      <div class="flex items-center gap-2 text-green-600 text-sm">
                        <el-icon><circle-check-filled /></el-icon>
                        <span>å·²æå– Â· è®¢å•å·: {{ contract.orderNo || 'æœªè¯†åˆ«' }}</span>
                      </div>
                      <div v-if="contract.products && contract.products.length" class="mt-2">
                        <el-tag v-for="(p, pi) in contract.products.slice(0, 3)" :key="pi" class="mr-1 mb-1">
                          {{ p.name }} - Â¥{{ p.unitPrice }}
                        </el-tag>
                        <el-tag v-if="contract.products.length > 3" size="small" type="info">
                          +{{ contract.products.length - 3 }} æ›´å¤š
                        </el-tag>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Extracted Data Table -->
              <div v-if="allExtractedProducts.length > 0" class="mt-6">
                <h3 class="section-title">æå–ç»“æœæ±‡æ€»</h3>
                <el-table :data="allExtractedProducts" border stripe max-height="400" style="width: 100%">
                  <el-table-column prop="contractName" label="åˆåŒæ–‡ä»¶" width="250" show-overflow-tooltip></el-table-column>
                  <el-table-column prop="orderNo" label="è®¢å•ç¼–å·" width="150"></el-table-column>
                  <el-table-column prop="name" label="äº§å“åç§°" width="150"></el-table-column>
                  <el-table-column prop="color" label="é¢œè‰²" width="100"></el-table-column>
                  <el-table-column prop="package" label="åŒ…è£…" width="100"></el-table-column>
                  <el-table-column prop="quantity" label="æ•°é‡" width="80"></el-table-column>
                  <el-table-column prop="unit" label="å•ä½" width="70"></el-table-column>
                  <el-table-column prop="unitPrice" label="å•ä»·" width="100">
                    <template #default="scope">
                      <span class="text-green-600 font-semibold">Â¥{{ scope.row.unitPrice }}</span>
                    </template>
                  </el-table-column>
                  <el-table-column prop="remark" label="å¤‡æ³¨" show-overflow-tooltip></el-table-column>
                  <el-table-column label="æ“ä½œ" width="80" fixed="right">
                    <template #default="scope">
                      <el-button type="primary" size="small" link @click="editProduct(scope.row, scope.$index)">
                        ç¼–è¾‘
                      </el-button>
                    </template>
                  </el-table-column>
                </el-table>
              </div>
            </div>

            <!-- Tab 2: AIé…ç½® -->
            <div v-if="activeTab === 1" key="ai-config">
              <h2 class="section-title">AIå¤§æ¨¡å‹é…ç½®</h2>

              <div class="config-card">
                <el-form :model="aiConfig" label-width="120px" class="max-w-2xl">
                  <el-form-item label="APIåœ°å€" required>
                    <el-input v-model="aiConfig.apiUrl" placeholder="https://api.openai.com/v1/chat/completions">
                      <template #prefix><el-icon>
                          <link />
                        </el-icon></template>
                    </el-input>
                  </el-form-item>

                  <el-form-item label="APIå¯†é’¥" required>
                    <el-input v-model="aiConfig.apiKey" type="password" placeholder="è¯·è¾“å…¥APIå¯†é’¥" show-password>
                      <template #prefix><el-icon>
                          <key />
                        </el-icon></template>
                    </el-input>
                  </el-form-item>

                  <el-form-item label="æ¨¡å‹åç§°" required>
                    <el-input v-model="aiConfig.apiModel" placeholder="gpt-4o / claude-3-sonnet / qwen-max">
                      <template #prefix><el-icon>
                          <cpu />
                        </el-icon></template>
                    </el-input>
                  </el-form-item>

                  <el-form-item label="æç¤ºè¯">
                    <el-input v-model="aiConfig.prompt" type="textarea" :rows="8" placeholder="è¯·è¾“å…¥AIæç¤ºè¯..." />
                  </el-form-item>

                  <el-form-item label="è¯·æ±‚è¶…æ—¶">
                    <el-input-number v-model="aiConfig.timeout" :min="10" :max="300" /> ç§’
                  </el-form-item>

                  <el-form-item label="é‡è¯•æ¬¡æ•°">
                    <el-input-number v-model="aiConfig.retryCount" :min="0" :max="5" />
                  </el-form-item>

                  <el-form-item>
                    <el-button type="primary" @click="saveAiConfig">
                      <el-icon>
                        <check />
                      </el-icon> ä¿å­˜é…ç½®
                    </el-button>
                    <el-button type="success" @click="testAiConnection" :loading="isTestingAi">
                      <el-icon>
                        <connection />
                      </el-icon> æµ‹è¯•è¿æ¥
                    </el-button>
                    <el-button @click="resetAiConfig">
                      <el-icon><refresh-right /></el-icon> é‡ç½®
                    </el-button>
                  </el-form-item>
                </el-form>
              </div>

              <!-- Connection Status -->
              <div v-if="aiTestResult" class="mt-4">
                <el-alert :title="aiTestResult.success ? 'è¿æ¥æˆåŠŸ' : 'è¿æ¥å¤±è´¥'"
                  :type="aiTestResult.success ? 'success' : 'error'" :description="aiTestResult.message" show-icon
                  closable @close="aiTestResult = null" />
              </div>

              <!-- Default Prompt Template -->
              <div class="config-card mt-6">
                <h3 class="font-semibold text-gray-700 mb-4">ğŸ“ é»˜è®¤æç¤ºè¯æ¨¡æ¿</h3>
                <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600 font-mono whitespace-pre-wrap">{{
                  defaultPrompt }}</div>
                <el-button type="primary" plain size="small" class="mt-3" @click="aiConfig.prompt = defaultPrompt">
                  ä½¿ç”¨æ­¤æ¨¡æ¿
                </el-button>
              </div>
            </div>


            <!-- Tab 3: å¯¼å‡º -->
            <div v-if="activeTab === 2" key="export">
              <h2 class="section-title">å¯¼å‡ºç»“æœ</h2>

              <div class="config-card">
                <h3 class="font-semibold text-gray-700 mb-4">ğŸ“Š å¯¼å‡ºé€‰é¡¹</h3>

                <div class="grid grid-cols-1 gap-6">
                  <div
                    class="border-2 border-dashed rounded-xl p-6 text-center cursor-pointer hover:border-green-500 hover:bg-green-50 transition-all"
                    @click="exportExtractedContracts">
                    <el-icon :size="48" color="#22c55e"><folder-checked /></el-icon>
                    <p class="text-lg font-medium mt-3">å¯¼å‡ºåˆåŒæå–æ•°æ®</p>
                    <p class="text-sm text-gray-500 mt-1">æ‰€æœ‰åˆåŒçš„äº§å“ä¿¡æ¯æ±‡æ€»</p>
                    <el-button type="success" class="mt-4" :disabled="allExtractedProducts.length === 0">
                      ç«‹å³å¯¼å‡º
                    </el-button>
                  </div>
                </div>
              </div>

              <!-- Export Progress -->
              <div v-if="isExporting" class="config-card mt-4">
                <div class="flex justify-between mb-2">
                  <span class="text-gray-600">å¯¼å‡ºè¿›åº¦</span>
                  <span class="text-gray-800 font-medium">{{ exportProgress }}%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" :style="{ width: exportProgress + '%' }"></div>
                </div>
              </div>

              <!-- Data Summary -->
              <div class="grid grid-cols-2 gap-4 mt-6">
                <div class="stats-card">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                      <el-icon :size="24" color="#3b82f6">
                        <folder />
                      </el-icon>
                    </div>
                    <div>
                      <p class="text-2xl font-bold text-gray-800">{{ contractFiles.length }}</p>
                      <p class="text-sm text-gray-500">åˆåŒæ–‡ä»¶</p>
                    </div>
                  </div>
                </div>
                <div class="stats-card">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                      <el-icon :size="24" color="#22c55e">
                        <goods />
                      </el-icon>
                    </div>
                    <div>
                      <p class="text-2xl font-bold text-gray-800">{{ allExtractedProducts.length }}</p>
                      <p class="text-sm text-gray-500">æå–äº§å“</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </transition>
        </div>
      </div>
    </div>

    <!-- PDF Preview Dialog -->
    <el-dialog v-model="pdfPreviewVisible" :title="currentPreviewPdf?.name || 'PDFé¢„è§ˆ'" width="80%" top="2vh">
      <div class="pdf-preview-container">
        <div class="flex justify-between items-center p-3 bg-gray-800">
          <div class="flex items-center gap-3">
            <el-button-group>
              <el-button size="small" @click="pdfPrevPage" :disabled="pdfCurrentPage <= 1">
                <el-icon><arrow-left /></el-icon>
              </el-button>
              <el-button size="small" disabled>
                {{ pdfCurrentPage }} / {{ pdfTotalPages }}
              </el-button>
              <el-button size="small" @click="pdfNextPage" :disabled="pdfCurrentPage >= pdfTotalPages">
                <el-icon><arrow-right /></el-icon>
              </el-button>
            </el-button-group>
          </div>
          <div class="flex items-center gap-2">
            <el-button size="small" @click="pdfZoomOut">
              <el-icon><zoom-out /></el-icon>
            </el-button>
            <span class="text-white text-sm">{{ Math.round(pdfScale * 100) }}%</span>
            <el-button size="small" @click="pdfZoomIn">
              <el-icon><zoom-in /></el-icon>
            </el-button>
            <el-button size="small" @click="pdfRotate">
              <el-icon><refresh-right /></el-icon>
            </el-button>
          </div>
        </div>
        <div class="pdf-canvas-container" ref="pdfContainer">
          <canvas ref="pdfCanvas" :style="{ transform: `rotate(${pdfRotation}deg)` }"></canvas>
        </div>
      </div>
    </el-dialog>



    <!-- Edit Product Dialog -->
    <el-dialog v-model="editProductVisible" title="ç¼–è¾‘äº§å“ä¿¡æ¯" width="500px">
      <el-form :model="editProductData" label-width="100px" v-if="editProductData">
        <el-form-item label="äº§å“åç§°">
          <el-input v-model="editProductData.name" />
        </el-form-item>
        <el-form-item label="é¢œè‰²">
          <el-input v-model="editProductData.color" />
        </el-form-item>
        <el-form-item label="åŒ…è£…">
          <el-input v-model="editProductData.package" />
        </el-form-item>
        <el-form-item label="æ•°é‡">
          <el-input-number v-model="editProductData.quantity" :min="0" />
        </el-form-item>
        <el-form-item label="å•ä½">
          <el-input v-model="editProductData.unit" />
        </el-form-item>
        <el-form-item label="å•ä»·">
          <el-input-number v-model="editProductData.unitPrice" :precision="2" :min="0" />
        </el-form-item>
        <el-form-item label="å¤‡æ³¨">
          <el-input type="textarea" rows="4" v-model="editProductData.remark" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="editProductVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="saveProductEdit">ä¿å­˜</el-button>
      </template>
    </el-dialog>
  </div>

  <script>
    // Set PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'

    const { createApp, ref, reactive, computed, watch, onMounted, nextTick } = Vue

    const app = createApp({
      setup() {
        // Navigation
        const tabs = [
          { name: 'åˆåŒä¸Šä¼ ', icon: 'FolderOpened' },
          { name: 'AIé…ç½®', icon: 'Setting' },
          { name: 'å¯¼å‡º', icon: 'Download' }
        ]
        const activeTab = ref(0)


        // PDF/Contract Upload
        const pdfInput = ref(null)
        const contractFiles = ref([])
        const isDraggingPdf = ref(false)
        const isExtractingAll = ref(false)

        // PDF Preview
        const pdfPreviewVisible = ref(false)
        const currentPreviewPdf = ref(null)
        const pdfCanvas = ref(null)
        const pdfContainer = ref(null)
        const pdfCurrentPage = ref(1)
        const pdfTotalPages = ref(0)
        const pdfScale = ref(1.0)
        const pdfRotation = ref(0)
        const pdfDoc = ref(null)

        // AI Config
        const aiConfig = reactive({
          apiUrl: '',
          apiKey: '',
          apiModel: '',
          prompt: '',
          timeout: 60,
          retryCount: 3
        })
        const isTestingAi = ref(false)
        const aiTestResult = ref(null)

        const defaultPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åˆåŒä¿¡æ¯æå–åŠ©æ‰‹ã€‚è¯·ä»ä»¥ä¸‹åˆåŒå†…å®¹ä¸­æå–ä¿¡æ¯ï¼Œå¹¶ä»¥JSONæ ¼å¼è¿”å›ã€‚

éœ€è¦æå–çš„ä¿¡æ¯ï¼š
1. orderNo: è®¢å•ç¼–å·/åˆåŒç¼–å·
2. products: äº§å“åˆ—è¡¨æ•°ç»„ï¼Œæ¯ä¸ªäº§å“åŒ…å«ï¼š
   - name: äº§å“åç§°
   - color: é¢œè‰²
   - package: åŒ…è£…
   - quantity: æ•°é‡
   - unit: å•ä½
   - unitPrice: å•ä»·ï¼ˆæ•°å­—ç±»å‹ï¼Œå¦‚æœ‰å¤šé¡¹è´¹ç”¨è¯·è®¡ç®—æ€»å•ä»·ï¼‰
   - remark: å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰

æ³¨æ„äº‹é¡¹ï¼š
- å¦‚æœæœ‰å¤šä¸ªäº§å“ï¼Œè¯·åˆ†åˆ«æå–
- è·³è¿‡æ€»ä»·æˆ–å•ä»·ä¸ºè´Ÿæ•°çš„äº§å“
- å•ä»·éœ€è¦åŒ…å«æ‰€æœ‰é™„åŠ è´¹ç”¨ï¼ˆå¦‚å¼€æ¨¡è´¹ã€å®šåˆ¶è´¹ã€åŠ å·¥è´¹ã€è¿è´¹ã€å®‰è£…è´¹ç­‰ï¼‰
- å¦‚æœè´¹ç”¨æ²¡æœ‰å•ä»·ï¼Œéœ€è¦ä½¿ç”¨æ€»ä»·/æ•°é‡è®¡ç®—å‡ºå•ä»·ï¼Œä¿ç•™ä¸¤ä½å°æ•°
- å¦‚æœå¤‡æ³¨ä¸­è¡¨ç¤ºéœ€è¦åŠ æ”¶çš„é‡‘é¢ï¼Œä¹Ÿéœ€è¦å¢åŠ åˆ°å•ä»·ä¸­
- å¦‚æœå¤‡æ³¨ä¸­è¡¨ç¤ºå•ä»·å·²åŒ…å«åŠ æ”¶,åˆ™ä¸éœ€è¦å¢åŠ åˆ°å•ä»·ä¸­
- å¦‚æœä¿¡æ¯ä¸å®Œæ•´ï¼Œç”¨nullè¡¨ç¤º
- ä»…è¿”å›JSONï¼Œä¸è¦å…¶ä»–è¯´æ˜

ç¤ºä¾‹è¾“å‡ºæ ¼å¼ï¼š
{
  "orderNo": "PO-2024-001",
  "products": [
    {"name": "äº§å“A", "color": "çº¢è‰²", "package": "ä¸­æ–‡åŒ…è£…", "quantity": 500, "unit": "ä¸ª", "unitPrice": 15000.00}
  ]
}

åˆåŒå†…å®¹ï¼š`


        // Edit Product
        const editProductVisible = ref(false)
        const editProductData = ref(null)
        const editProductIndex = ref(-1)

        // Export
        const isExporting = ref(false)
        const exportProgress = ref(0)

        // Computed
        const allExtractedProducts = computed(() => {
          const products = []
          contractFiles.value.forEach(contract => {
            if (contract.products && contract.products.length) {
              contract.products.forEach(p => {
                products.push({
                  ...p,
                  contractName: contract.name,
                  orderNo: contract.orderNo
                })
              })
            }
          })
          console.log("ğŸš€ ~ products:", products)
          return products
        })







        // Methods
        const formatFileSize = (bytes) => {
          if (bytes < 1024) return bytes + ' B'
          if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB'
          return (bytes / (1024 * 1024)).toFixed(2) + ' MB'
        }


        // PDF Methods
        const triggerPdfUpload = () => {
          pdfInput.value.click()
        }

        const handlePdfUpload = (e) => {
          const files = Array.from(e.target.files)
          files.forEach(processPdfFile)
          e.target.value = ''
        }

        const handlePdfDrop = (e) => {
          isDraggingPdf.value = false
          const files = Array.from(e.dataTransfer.files)
          files.forEach(processPdfFile)
        }

        const processPdfFile = async (file) => {
          if (file.type !== 'application/pdf') {
            ElementPlus.ElMessage.error(`${file.name} ä¸æ˜¯PDFæ–‡ä»¶`)
            return
          }

          if (file.size > 20 * 1024 * 1024) {
            ElementPlus.ElMessage.error(`${file.name} è¶…è¿‡20MBé™åˆ¶`)
            return
          }

          // Check duplicate
          if (contractFiles.value.some(c => c.name === file.name)) {
            ElementPlus.ElMessage.warning(`${file.name} å·²å­˜åœ¨`)
            return
          }

          const arrayBuffer = await file.arrayBuffer()
          const base64 = btoa(
            new Uint8Array(arrayBuffer).reduce((data, byte) => data + String.fromCharCode(byte), '')
          )

          contractFiles.value.push({
            name: file.name,
            size: file.size,
            data: base64,
            uploadTime: new Date().toLocaleString(),
            extracted: false,
            extracting: false,
            orderNo: null,
            products: []
          })

          saveToLocalStorage()
          ElementPlus.ElMessage.success(`${file.name} ä¸Šä¼ æˆåŠŸ`)
        }

        const removeContract = (index) => {
          contractFiles.value.splice(index, 1)
          saveToLocalStorage()
        }

        const clearAllContracts = () => {
          contractFiles.value = []
          saveToLocalStorage()
          ElementPlus.ElMessage.success('å·²æ¸…é™¤æ‰€æœ‰åˆåŒ')
        }

        // PDF Preview
        const previewPdf = async (contract) => {
          currentPreviewPdf.value = contract
          pdfPreviewVisible.value = true
          pdfCurrentPage.value = 1
          pdfScale.value = 1.0
          pdfRotation.value = 0

          await nextTick()
          await loadPdfPage()
        }

        const loadPdfPage = async () => {
          if (!currentPreviewPdf.value) return

          try {
            const binary = atob(currentPreviewPdf.value.data)
            const bytes = new Uint8Array(binary.length)
            for (let i = 0; i < binary.length; i++) {
              bytes[i] = binary.charCodeAt(i)
            }

            const pdf = await pdfjsLib.getDocument({ data: bytes }).promise
            pdfDoc.value = pdf
            pdfTotalPages.value = pdf.numPages

            const page = await pdf.getPage(pdfCurrentPage.value)
            const viewport = page.getViewport({ scale: pdfScale.value })

            const canvas = pdfCanvas.value
            const context = canvas.getContext('2d')
            canvas.height = viewport.height
            canvas.width = viewport.width

            await page.render({
              canvasContext: context,
              viewport: viewport
            }).promise
          } catch (error) {
            console.error('PDFåŠ è½½å¤±è´¥:', error)
            ElementPlus.ElMessage.error('PDFåŠ è½½å¤±è´¥')
          }
        }

        const pdfPrevPage = () => {
          if (pdfCurrentPage.value > 1) {
            pdfCurrentPage.value--
            loadPdfPage()
          }
        }

        const pdfNextPage = () => {
          if (pdfCurrentPage.value < pdfTotalPages.value) {
            pdfCurrentPage.value++
            loadPdfPage()
          }
        }

        const pdfZoomIn = () => {
          pdfScale.value = Math.min(3, pdfScale.value + 0.25)
          loadPdfPage()
        }

        const pdfZoomOut = () => {
          pdfScale.value = Math.max(0.5, pdfScale.value - 0.25)
          loadPdfPage()
        }

        const pdfRotate = () => {
          pdfRotation.value = (pdfRotation.value + 90) % 360
        }

        // AI Methods
        const extractContractData = async (contract) => {
          if (!aiConfig.apiUrl || !aiConfig.apiKey || !aiConfig.apiModel) {
            ElementPlus.ElMessage.warning('è¯·å…ˆé…ç½®AIè¿æ¥ä¿¡æ¯')
            activeTab.value = 2
            return
          }

          contract.extracting = true

          try {
            // Extract text from PDF
            const pdfText = await extractPdfText(contract)

            // Call AI API
            const result = await callAiApi(pdfText)
            console.log("ğŸš€ ~ extractContractData ~ result:", result)
            if (result) {
              contract.orderNo = result.orderNo
              contract.products = result.products || []
              contract.extracted = false
              saveToLocalStorage()
              ElementPlus.ElMessage.success(`${contract.name} æå–æˆåŠŸ`)
            }
          } catch (error) {
            console.error('æå–å¤±è´¥:', error)
            ElementPlus.ElMessage.error('æå–å¤±è´¥: ' + error.message)
          } finally {
            contract.extracting = false
          }
        }

        const extractPdfText = async (contract) => {
          const binary = atob(contract.data)
          const bytes = new Uint8Array(binary.length)
          for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i)
          }

          const pdf = await pdfjsLib.getDocument({ data: bytes }).promise
          let text = ''

          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i)
            const content = await page.getTextContent()
            text += content.items.map(item => item.str).join(' ') + '\n'
          }

          return text
        }

        const callAiApi = async (pdfText, retryCount = 0) => {
          const prompt = (aiConfig.prompt || defaultPrompt) + '\n\n' + pdfText

          try {
            const controller = new AbortController()
            const timeoutId = setTimeout(() => controller.abort(), aiConfig.timeout * 1000)

            const response = await fetch(aiConfig.apiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${aiConfig.apiKey}`
              },
              body: JSON.stringify({
                model: aiConfig.apiModel,
                messages: [
                  { role: 'user', content: prompt }
                ],
                temperature: 0.1
              }),
              signal: controller.signal
            })

            clearTimeout(timeoutId)

            if (!response.ok) {
              throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`)
            }

            const data = await response.json()
            let content = data.choices?.[0]?.message?.content || data.content || ''
            console.log("ğŸš€ ~ callAiApi ~ content:", content)

            // Extract JSON from response
            const jsonMatch = content.match(/\{[\s\S]*\}/)
            console.log("ğŸš€ ~ callAiApi ~ jsonMatch:", jsonMatch)
            if (jsonMatch) {
              return JSON.parse(jsonMatch[0])
            }

            throw new Error('æœªèƒ½è§£æAIè¿”å›çš„JSONæ•°æ®')
          } catch (error) {
            if (retryCount < aiConfig.retryCount) {
              console.log(`é‡è¯•ç¬¬ ${retryCount + 1} æ¬¡...`)
              await new Promise(r => setTimeout(r, 1000))
              return callAiApi(pdfText, retryCount + 1)
            }
            throw error
          }
        }

        const extractAllContracts = async () => {
          const unextracted = contractFiles.value.filter(c => !c.extracted)
          if (unextracted.length === 0) {
            ElementPlus.ElMessage.info('æ‰€æœ‰åˆåŒå·²æå–å®Œæˆ')
            return
          }

          if (!aiConfig.apiUrl || !aiConfig.apiKey) {
            ElementPlus.ElMessage.warning('è¯·å…ˆé…ç½®AIè¿æ¥ä¿¡æ¯')
            activeTab.value = 2
            return
          }

          isExtractingAll.value = true

          for (const contract of unextracted) {
            await extractContractData(contract)
            // Rate limiting
            await new Promise(r => setTimeout(r, 500))
          }

          isExtractingAll.value = false
          ElementPlus.ElMessage.success('æ‰¹é‡æå–å®Œæˆ')
        }

        // AI Config Methods
        const saveAiConfig = () => {
          localStorage.setItem('aiConfig', JSON.stringify({
            apiUrl: aiConfig.apiUrl,
            apiKey: btoa(aiConfig.apiKey), // Simple encoding
            apiModel: aiConfig.apiModel,
            prompt: aiConfig.prompt,
            timeout: aiConfig.timeout,
            retryCount: aiConfig.retryCount
          }))
          ElementPlus.ElMessage.success('é…ç½®å·²ä¿å­˜')
        }

        const loadAiConfig = () => {
          const saved = localStorage.getItem('aiConfig')
          if (saved) {
            try {
              const config = JSON.parse(saved)
              aiConfig.apiUrl = config.apiUrl || ''
              aiConfig.apiKey = config.apiKey ? atob(config.apiKey) : ''
              aiConfig.apiModel = config.apiModel || ''
              aiConfig.prompt = config.prompt || ''
              aiConfig.timeout = config.timeout || 60
              aiConfig.retryCount = config.retryCount || 3
            } catch (e) {
              console.error('åŠ è½½AIé…ç½®å¤±è´¥', e)
            }
          }
        }

        const resetAiConfig = () => {
          aiConfig.apiUrl = ''
          aiConfig.apiKey = ''
          aiConfig.apiModel = ''
          aiConfig.prompt = ''
          aiConfig.timeout = 60
          aiConfig.retryCount = 3
        }

        const testAiConnection = async () => {
          if (!aiConfig.apiUrl || !aiConfig.apiKey || !aiConfig.apiModel) {
            ElementPlus.ElMessage.warning('è¯·å¡«å†™å®Œæ•´çš„APIé…ç½®')
            return
          }

          isTestingAi.value = true
          aiTestResult.value = null

          try {
            const response = await fetch(aiConfig.apiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${aiConfig.apiKey}`
              },
              body: JSON.stringify({
                model: aiConfig.apiModel,
                messages: [
                  { role: 'user', content: 'è¯·å›å¤"è¿æ¥æˆåŠŸ"' }
                ],
                max_tokens: 10
              })
            })

            if (response.ok) {
              aiTestResult.value = { success: true, message: 'APIè¿æ¥æµ‹è¯•æˆåŠŸï¼Œé…ç½®æœ‰æ•ˆ' }
            } else {
              const error = await response.json()
              aiTestResult.value = { success: false, message: `è¿æ¥å¤±è´¥: ${error.error?.message || response.status}` }
            }
          } catch (error) {
            aiTestResult.value = { success: false, message: `è¿æ¥å¤±è´¥: ${error.message}` }
          } finally {
            isTestingAi.value = false
          }
        }





        // Edit Product
        const editProduct = (product, index) => {
          editProductData.value = { ...product }
          editProductIndex.value = index
          editProductVisible.value = true
        }

        const saveProductEdit = () => {
          // Find and update the product in contractFiles
          let found = false
          for (const contract of contractFiles.value) {
            if (contract.products) {
              const idx = contract.products.findIndex(p =>
                p.name === allExtractedProducts.value[editProductIndex.value].name &&
                p.contractName === contract.name
              )
              if (idx >= 0) {
                contract.products[idx] = { ...editProductData.value }
                found = true
                break
              }
            }
          }

          editProductVisible.value = false
          saveToLocalStorage()
          ElementPlus.ElMessage.success('äº§å“ä¿¡æ¯å·²æ›´æ–°')
        }


        const exportExtractedContracts = () => {
          if (allExtractedProducts.value.length === 0) {
            ElementPlus.ElMessage.warning('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®')
            return
          }

          const ws = XLSX.utils.json_to_sheet(allExtractedProducts.value)
          const wb = XLSX.utils.book_new()
          XLSX.utils.book_append_sheet(wb, ws, 'åˆåŒäº§å“æ•°æ®')
          XLSX.writeFile(wb, `åˆåŒäº§å“æ•°æ®_${new Date().toLocaleDateString()}.xlsx`)

          ElementPlus.ElMessage.success('å¯¼å‡ºæˆåŠŸ')
        }

        // Local Storage
        const saveToLocalStorage = () => {
          try {
            const data = {

              contractFiles: contractFiles.value.map(c => ({
                ...c,
                data: c.data // Include base64 data
              })),

            }
            localStorage.setItem('reconciliationData', JSON.stringify(data))
          } catch (e) {
            console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e)
            // If storage is full, try to save without PDF data
            if (e.name === 'QuotaExceededError') {
              const lightData = {
                contractFiles: contractFiles.value.map(c => ({
                  name: c.name,
                  size: c.size,
                  uploadTime: c.uploadTime,
                  extracted: c.extracted,
                  orderNo: c.orderNo,
                  products: c.products
                })),
              }
              localStorage.setItem('reconciliationData', JSON.stringify(lightData))
              ElementPlus.ElMessage.warning('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼ŒPDFæ–‡ä»¶æ•°æ®æœªä¿å­˜')
            }
          }
        }

        const loadFromLocalStorage = () => {
          try {
            const saved = localStorage.getItem('reconciliationData')
            if (saved) {
              const data = JSON.parse(saved)
              contractFiles.value = data.contractFiles || []
            }
          } catch (e) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', e)
          }
        }

        const clearAllData = () => {
          ElementPlus.ElMessageBox.confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', 'è­¦å‘Š', {
            confirmButtonText: 'ç¡®å®š',
            cancelButtonText: 'å–æ¶ˆ',
            type: 'warning'
          }).then(() => {
            contractFiles.value = []
            localStorage.removeItem('reconciliationData')
            ElementPlus.ElMessage.success('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤')
          }).catch(() => { })
        }

        // Lifecycle
        onMounted(() => {
          loadFromLocalStorage()
          loadAiConfig()
        })

        return {
          // Navigation
          tabs,
          activeTab,
          // æ–‡ä»¶å¤§å°
          formatFileSize,

          // PDF/Contract
          pdfInput,
          contractFiles,
          isDraggingPdf,
          isExtractingAll,
          triggerPdfUpload,
          handlePdfUpload,
          handlePdfDrop,
          removeContract,
          clearAllContracts,
          extractContractData,
          extractAllContracts,
          allExtractedProducts,

          // PDF Preview
          pdfPreviewVisible,
          currentPreviewPdf,
          pdfCanvas,
          pdfContainer,
          pdfCurrentPage,
          pdfTotalPages,
          pdfScale,
          pdfRotation,
          previewPdf,
          pdfPrevPage,
          pdfNextPage,
          pdfZoomIn,
          pdfZoomOut,
          pdfRotate,

          // AI Config
          aiConfig,
          isTestingAi,
          aiTestResult,
          defaultPrompt,
          saveAiConfig,
          resetAiConfig,
          testAiConnection,




          // Edit Product
          editProductVisible,
          editProductData,
          editProduct,
          saveProductEdit,

          // Export
          isExporting,
          exportProgress,
          exportExtractedContracts,

          // Utils
          clearAllData
        }
      }
    })

    // Register Element Plus icons
    for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
      app.component(key, component)
    }

    app.use(ElementPlus)
    app.mount('#app');
  </script>
</body>

</html>